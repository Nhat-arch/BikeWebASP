@model App.Models.ProductViewModel;
@{
    ViewData["title"] = "Thêm sản phẩm";
}
<div class="row">
    <div class="col-md-5">
        <div class="panel panel-default">
            <div class="panel-body">
                <form id="form1" asp-area="Admin" asp-controller="Product" asp-action="ProductAdd" method="post"
                    enctype="multipart/form-data">
                    <div>
                        @if (TempData["Success"] != null)
                        {
                            <div class="alert alert-success">
                                @TempData["Success"]
                            </div>
                        }
                    </div>
                    <div class="form-group">
                        <label class="control-label">Tên sản phẩm</label>
                        <input asp-for="Product.ProductName" class="form-control" />
                        <span asp-validation-for="Product.ProductName" class="text-danger"></span>
                        @if (TempData["TonTai"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["TonTai"]
                            </div>
                        }
                    </div>
                    <div class="form-group">
                        <label class="control-label">Hãng sản xuất</label>
                        <select asp-for="Product.BrandId" class="form-control">
                            <option value="0">-- Chọn hãng sản xuất --</option>
                            @foreach (var b in Model.BrandList)
                            {
                                <option value="@b.BrandId">@b.BrandName</option>
                            }
                        </select>
                        <span asp-validation-for="Product.BrandId" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Loại sản phẩm</label>
                        <select asp-for="Product.TypeId" class="form-control">
                            <option value="0">-- Chọn loại sản phẩm --</option>
                            @foreach (var t in Model.TypeList)
                            {
                                <option value="@t.TypeId">@t.TypeName</option>
                            }
                        </select>
                        <span asp-validation-for="Product.TypeId" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Đơn giá</label>
                        <input asp-for="Product.ProductPrice" class="form-control" type="number" step="1000" />
                        <span asp-validation-for="Product.ProductPrice" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Mô tả</label>
                        <textarea asp-for="Product.ProductDescription" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Product.ProductDescription" class="text-danger"></span>
                    </div>
                    @* upload img  *@
                    <div class="form-group">
                        <label class="control-label">Hình ảnh</label>
                        <input type="hidden" id="imgUploadCount" name="imgUploadCount" value="0">

                        <div id="imgContainer" class="preview" style="display:none;">
                        </div>

                        <!-- Preview ảnh -->
                        <div id="preview" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>

                        <button type="button" id="addImageBtn" class="btn btn-secondary mt-2">+ Thêm ảnh</button>

                        @if (TempData["ImageError"] != null)
                        {
                            <span class="text-danger">@TempData["ImageError"]</span>
                        }
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-plus"></i> Thêm sản phẩm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="panel panel-default">
            <div class="panel-body">
                <form id="form3" asp-area="Admin" asp-controller="Product" asp-action="BrandAdd" method="post">
                    <div class="form-group">
                        <label class="control-label">Thêm hãng sản xuất</label>
                        <input asp-for="Brand.BrandName" type="text" class="form-control" />
                        <span asp-validation-for="Brand.BrandName" class="text-danger"></span>
                        @if (TempData["BrandSuccess"] != null)
                        {
                            <span class="text-success">
                                @TempData["BrandSuccess"]
                            </span>
                        }
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-plus"></i> Thêm
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body">
                <form id="form2" asp-area="Admin" asp-controller="Product" asp-action="TypeAdd" method="post">
                    <div class="form-group">
                        <label class="control-label">Thêm loại sản phẩm </label>
                        <input asp-for="Type.TypeName" type="text" class="form-control" />
                        <span asp-validation-for="Type.TypeName" class="text-danger"></span>
                        @if (TempData["TypeSuccess"] != null)
                        {
                            <span class="text-success">
                                @TempData["TypeSuccess"]
                            </span>
                        }
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-plus"></i> Thêm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    
<script>
  const imgContainer = document.getElementById("imgContainer");
  const preview = document.getElementById("preview");
  const imgUploadCount = document.getElementById("imgUploadCount");
  const addImageBtn = document.getElementById("addImageBtn");

  let selectedFiles = [];

  // Khi nhấn nút thêm ảnh
  addImageBtn.addEventListener("click", () => {
    const count = parseInt(imgUploadCount.value);
    const newInput = document.createElement("input");
    newInput.type = "file";
    newInput.name = "file[]";
    newInput.accept = ".jpg,.jpeg,.png";
    newInput.style.display = "none";

    // Khi người dùng chọn file
    newInput.addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;
      // Kiểm tra định dạng file
      const allowedTypes = ["image/jpeg", "image/png", "image/jpg"];
      if (!allowedTypes.includes(file.type)) {
        alert("Chỉ chấp nhận file .jpg, .jpeg, .png");
        this.value = "";
        return;
      }
      // Kiểm tra kích thước file (tối đa 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert("Kích thước file không được vượt quá 5MB!");
        this.value = "";
        return;
      }
      // Thêm file vào danh sách và hiển thị preview
      selectedFiles.push({ input: this, file });
      renderPreview();
      imgUploadCount.value = count + 1;
    });
    imgContainer.appendChild(newInput);
    newInput.click(); // tự động mở hộp thoại chọn ảnh
  });

  // Hiển thị preview
  function renderPreview() {
    preview.innerHTML = "";
    selectedFiles.forEach((item, index) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const imgBox = document.createElement("div");
        imgBox.classList.add("img-box");
        imgBox.style.position = "relative";
        imgBox.innerHTML = `
          <img src="${e.target.result}" alt="Ảnh ${index+1}" 
               style="width:120px;height:120px;object-fit:cover;border-radius:8px;">
          <button class="remove-btn" data-index="${index}" 
                  style="position:absolute;top:2px;right:2px;background:red;color:white;
                         border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;">×</button>
        `;
        preview.appendChild(imgBox);
      };
      reader.readAsDataURL(item.file);
    });
  }

  // Xóa ảnh khỏi preview và input tương ứng
  preview.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-btn")) {
      const index = e.target.getAttribute("data-index");
      imgContainer.removeChild(selectedFiles[index].input); // xóa input tương ứng
      selectedFiles.splice(index, 1);
      renderPreview();
    }
  });
</script>
}